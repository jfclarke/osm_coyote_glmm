---
title: 'coyote_formatting script'
author: "authors: Jamie Clarke, Marissa Dyck, Larissa Bron, Madison Carlson, Sophia Labiy, Zoe Penno, Hayley Webster, Jason T Fisher"
date: "last updated: 27/12/2024"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## about
This is walk-through on how to format data for *the coyote manuscript*. It was written by Jamie Clarke with help from Dr. Marissa Dyck and based on preliminary code by Larissa Bron. The data required to run the script is available on Jamie's GitHub at https://github.com/jfclarke/osm_coyote_glmm. Happy formatting :-)

## 1) set-up

#### start by loading in relevant packages:
```{r packages, message=FALSE}
library(tidyverse)
library(PerformanceAnalytics)
library(purrr)
```

## 2) data import

#### a) load in percent cover of human/vegetation features:
```{r landcover, message=FALSE}
landcover <- 

  read_csv('data/raw/OSM_covariates_grouped_2021_2022.csv') %>% 
  
  # select relevant features
  select(array,
         site,
         buff_dist,
         pipeline,
         roads,
         seismic_lines,
         seismic_lines_3D,
         trails,
         transmission_lines,
         lc_grassland,
         lc_coniferous,
         lc_broadleaf,
         lc_mixed,
         lc_shrub) %>%
  
  # combine natural landcover types into nat_land (i.e., natural landcover)
  mutate(nat_land = 
           lc_grassland +
           lc_coniferous +
           lc_broadleaf +
           lc_mixed +
           lc_shrub)
```

#### b) load in proportional detections of coyotes:
```{r coyote_det, message=FALSE}
coyote_det <-
  
  read_csv('data/raw/OSM_proportional_detections_merged_2021_2022.csv') %>% 
  
  # rename coyote presence and absence for clarity
  rename(coyote_pres = coyote, # new variable name = coyote_pres
         coyote_abs = absent_coyote) %>% # new variable name = coyote_abs
  
  # select site (LU #), coyote_pres and coyote_abs
  select(site,
         coyote_pres,
         coyote_abs)
```

#### c) load in total detections of other mammal species and join the 2021-2022 + 2022-2023 datasets using purr:
```{r mammal_det, message=FALSE}
mammal_det <- 
   
  # provide file path
  file.path('data/raw',
            c('OSM_total_detections_2021.csv',
              'OSM_2022_total_detections.csv')) %>% 
  
            # use purr map_dfr to read in files and merge them
            map_dfr(
              ~.x %>% 
                read_csv(.,
                         col_types = cols(site = col_factor(),
                                          .default = col_integer()))) %>% 
  # reformat column names
  set_names(
    names(.) %>% 
      tolower() %>% # change letters to lower case
      gsub(" ", "_", .) %>% # substitute spaces for underscores
      gsub("-", "_", .)) %>% # substitute dashes for underscores
  
  # rename coyote column as coyote_tot to easily differentiate between proportional coyote detections
  rename(coyote_tot = coyote) %>% 
  
  # select relevant mammal species
  select(site,
         coyote_tot,
         fisher,
         snowshoe_hare,
         white_tailed_deer,
         cougar,
         lynx,
         red_squirrel,
         moose,
         grey_wolf,
         caribou)
```

#### d) join dataframes together into coyote_data master dataframe and clean it up:
```{r coyote_data, message=FALSE}
coyote_data <-
  
landcover %>% 
  
  left_join(coyote_det,
            by = 'site') %>% 
  
  left_join(mammal_det,
            by = 'site') %>% 
  
  # filter this dataset for buffer distance of 4750 m
  # 4750 m was the top-performing buffer scale for coyotes when considering anthropogenic features - as described in other work on the OSM project
  filter(buff_dist == 4750) %>% 
  
  # remove columns not needed
  select(-c(buff_dist,
            lc_grassland,
            lc_coniferous,
            lc_broadleaf,
            lc_mixed,
            lc_shrub))
```

#### e) remove old dataframes from the environment to keep things organized:
```{r rm, message=FALSE}
rm(coyote_det,
   landcover,
   mammal_det)
```

## 3) data exploration

#### a) check histograms for each covariate of interest - looking for very left-skewed, zero-inflated plots that indicate little presence on the lansdscape (for modelling):
```{r hist}
hist(coyote_data$nat_land)
hist(coyote_data$pipeline)
hist(coyote_data$roads)
hist(coyote_data$seismic_lines)
hist(coyote_data$seismic_lines_3D)
hist(coyote_data$trails)
hist(coyote_data$transmission_lines)
hist(coyote_data$fisher)
hist(coyote_data$snowshoe_hare)
hist(coyote_data$white_tailed_deer)
hist(coyote_data$cougar)
hist(coyote_data$lynx)
hist(coyote_data$red_squirrel)
hist(coyote_data$moose)
hist(coyote_data$grey_wolf)
hist(coyote_data$caribou)
```

#### b) the plots above show us that there are too few detections of cougars and caribou to take further into analyses - so remove cougars and caribou from the dataframe:
```{r rm_cougar_caribou, message=FALSE}
coyote_data <-
  
  coyote_data %>% 
  
  select(-c(cougar,
            caribou))
```

## 4) save formatted project dataframe

#### save coyote_data as .csv in 'processed' data folder:
```{r save_df, message=FALSE}
write_csv(coyote_data,
          'data/processed/coyote_data.csv')
```

## 5) test for correlation

#### a) make a new variable of all the covariates to consider:
```{r coyote_cor, message=FALSE}
coyote_cor <-
  
  coyote_data %>%
  
  select(pipeline,
         roads,
         seismic_lines,
         seismic_lines_3D,
         trails,
         transmission_lines,
         nat_land,
         fisher,
         snowshoe_hare,
         white_tailed_deer,
         lynx,
         red_squirrel,
         moose,
         grey_wolf)
```

#### <span style="color: darkblue;">side note:</span> the text size in the correlation plots is really tiny...
#### to change that, run the following line of code and, in the pop-up window, on line 17, change 'cex' to 5 (or whatever you want):
```{r cex, eval=FALSE}
trace("chart.Correlation",
      edit = T)
```

#### b) graph a Pearson's correlation matrix:
```{r pearson, warning=FALSE}
chart.Correlation(coyote_cor,
                  histogram = TRUE,
                  method = 'pearson')
```
  
results:  
- transmission lines and pipelines = 0.64  
- roads and pipelines = 0.60

#### c) graph a Spearman's correlation matrix:
```{r spearman, warning=FALSE}
chart.Correlation(coyote_cor,
                  histogram = TRUE,
                  method = 'spearman')
```
  
results:  
- roads and pipelines = 0.70  
- transmission lines and pipelines = 0.69  
- 3D seismic lines and pipelines: 0.69
